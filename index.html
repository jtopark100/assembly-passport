<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover"/>
    <title>KIA ì¡°ë¦½1ë¶€ ë¬¸í™”ì—¬ê¶Œ</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@700;900&family=Pretendard:wght@400;600;800&display=swap');
        :root { --passport-navy: #1a2e5a; --passport-gold: #d4af37; --kia-red: #bb0a30; --success-blue: #0047ab; --success-green: #28a745; }
        
        body { margin: 0; font-family: 'Pretendard', sans-serif; background: #fdfaf2; padding-bottom: calc(100px + env(safe-area-inset-bottom)); overflow-x: hidden; }
        .container { padding: 15px; max-width: 500px; margin: 0 auto; }
        .card { background: white; border-radius: 18px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 15px; border: 1px solid #efefef; }

        /* [ì—…ë¡œë“œ íƒ­ - ì ìˆ˜ ë²„íŠ¼ ìƒ‰ìƒ] */
        .score-box { display: flex; gap: 8px; margin: 10px 0; }
        .score-btn { flex: 1; padding: 12px; border-radius: 10px; border: 2px solid #eee; font-weight: 800; cursor: pointer; background: #fff; color: #999; }
        .score-btn.active-base { border-color: #888; background: #f0f0f0; color: #333; } /* ê¸°ë³¸ 5ì  */
        .score-btn.active-leader { border-color: var(--kia-red); background: #fff0f0; color: var(--kia-red); } /* íŒ€ì¥ 2ì  */
        .score-btn.active-self { border-color: var(--success-blue); background: #f0f7ff; color: var(--success-blue); } /* ìë°œ 3ì  */

        /* [ì—¬ê¶Œ íƒ­ - ì¸ìŠ¤íƒ€ í”¼ë“œ & ë°°ì§€] */
        .passport-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .month-box { background: white; border-radius: 15px; overflow: hidden; height: 180px; border: 1px solid #e5e5ea; position: relative; }
        .new-badge { position: absolute; top: 8px; right: 8px; background: red; color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; font-weight: 800; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .role-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 4px; font-weight: 800; }
        .badge-leader { background: #fff0f0; color: #e12e2e; }
        .badge-self { background: #f0f7ff; color: #0047ab; }
        .feed-img-slider { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; scrollbar-width: none; background: #000; }
        .feed-img-slider img { width: 100%; flex-shrink: 0; aspect-ratio: 1/1; object-fit: cover; scroll-snap-align: center; }

        /* [ê´€ë¦¬ì ìŠ¹ì¸ UI] */
        .pending-scroll { display: flex; gap: 10px; overflow-x: auto; margin: 10px 0; padding-bottom: 5px; }
        .pending-scroll img { width: 120px; height: 120px; object-fit: cover; border-radius: 10px; flex-shrink: 0; }
        .admin-btns { display: flex; gap: 8px; margin-top: 15px; }
        .admin-btns button { flex: 1; padding: 15px; border-radius: 12px; border: none; font-weight: 800; color: white; cursor: pointer; }

        /* í•˜ë‹¨ íƒ­ ë””ìì¸ ë³µêµ¬ */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--passport-navy); display: flex; padding-bottom: env(safe-area-inset-bottom); height: calc(70px + env(safe-area-inset-bottom)); z-index: 1000; border-top: 2px solid var(--passport-gold); }
        .bottom-nav a { flex: 1; text-decoration: none; display: flex; flex-direction: column; align-items: center; justify-content: center; color: rgba(255,255,255,0.5); font-size: 11px; }
        .bottom-nav a.active-link { color: var(--passport-gold); font-weight: 800; }

        [data-view] { display: none; } [data-view].active { display: block; }
        #zoom-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:3000; align-items:center; justify-content:center; }
    </style>
</head>
<body>

<div id="view-home" data-view class="active">
    <div style="background: var(--passport-navy); min-height: 80vh; margin: 15px; border-radius: 20px; padding: 40px 25px; color: var(--passport-gold); display: flex; flex-direction: column; position: relative;">
        <div style="font-size: 12px; letter-spacing: 5px; opacity:0.8;">REPUBLIC OF KOREA</div>
        <div style="align-self: flex-end; width: 100px; height: 100px; border: 2.5px solid var(--passport-gold); border-radius: 50%; display: flex; align-items: center; justify-content: center;"><span style="font-size: 60px;">âœ¿</span></div>
        <div style="margin-top: auto;">
            <div style="font-family: 'Noto Serif KR', serif; font-size: 45px; font-weight: 900; margin-bottom: 5px;">ë¬¸í™”ì—¬ê¶Œ</div>
            <div style="font-size: 22px; letter-spacing: 3px; font-weight: 600;">PASSPORT</div>
        </div>
    </div>
</div>

<div id="view-mission" data-view class="container">
    <div id="admin-approval-area" style="display:none; margin-bottom:40px;">
        <h3 style="color:var(--kia-red);">ğŸ“¢ ìŠ¹ì¸ ëŒ€ê¸° ë¦¬ìŠ¤íŠ¸</h3>
        <div id="pending-list"></div>
    </div>
    <div id="admin-mission-area" style="display:none;" class="card">
        <h4>ğŸ› ï¸ ë¯¸ì…˜ ì„¤ì •</h4>
        <input type="text" id="new-mission-text" placeholder="ë¯¸ì…˜ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”">
        <label style="display:block; margin: 10px 0;"><input type="checkbox" id="is-hidden-chk"> ìˆ¨ì€ ë¯¸ì…˜ìœ¼ë¡œ ì„¤ì •</label>
        <button onclick="saveMission()" class="btn-main" style="width:100%; padding:15px; background:var(--passport-navy); color:var(--passport-gold); border:none; border-radius:12px; font-weight:800;">ë“±ë¡í•˜ê¸°</button>
    </div>
    <h3>ğŸ¯ ë¯¸ì…˜ ê°€ì´ë“œ</h3>
    <div id="mission-pool-list"></div>
</div>

<div id="view-passport" data-view class="container">
    <h3 style="font-weight: 800;">ğŸ“– í™œë™ ê¸°ë¡ë¶€</h3>
    <div class="passport-grid" id="passport-grid"></div>
</div>

<div id="view-ranking" data-view class="container">
    <h3 style="text-align:center; font-weight: 800;">ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹</h3>
    <div id="podium-area" style="display: flex; align-items: flex-end; justify-content: center; height: 180px; margin: 40px 0 20px; gap: 10px;"></div>
    <div class="card" id="rank-list" style="padding:0; overflow:hidden;"></div>
</div>

<div id="view-upload" data-view class="container">
    <div class="card">
        <h3 style="margin-top:0;">ğŸ“¸ í™œë™ ì¸ì¦</h3>
        <select id="up-month" style="width:100%; padding:12px; border-radius:10px; margin-bottom:10px;">
            <script>for(let i=1;i<=12;i++)document.write(`<option value="${i}">${i}ì›” í™œë™ ì¸ì¦</option>`)</script>
        </select>
        <input type="text" id="up-names" placeholder="ì°¸ì—¬ì ì´ë¦„ (ì‰¼í‘œë¡œ êµ¬ë¶„: í™ê¸¸ë™, ê¹€ì² ìˆ˜)" style="width:100%; padding:12px; border-radius:10px; box-sizing:border-box;">
        <div class="score-box">
            <button id="btn-base" class="score-btn active-base" onclick="toggleScore('base')">ê¸°ë³¸ 5ì </button>
            <button id="btn-leader" class="score-btn" onclick="toggleScore('leader')">íŒ€ì¥ +2ì </button>
            <button id="btn-self" class="score-btn" onclick="toggleScore('self')">ìë°œ +3ì </button>
        </div>
        <textarea id="up-content" placeholder="ì˜¤ëŠ˜ í™œë™ì€ ì–´ë– ì…¨ë‚˜ìš”?" rows="4" style="width:100%; padding:12px; border-radius:10px; margin-top:10px; box-sizing:border-box;"></textarea>
        <input type="file" id="up-img" multiple accept="image/*" style="margin-top:15px;">
        <button onclick="submitUpload()" id="up-btn" style="width:100%; padding:18px; background:var(--passport-navy); color:var(--passport-gold); border:none; border-radius:15px; font-weight:800; margin-top:20px;">ğŸ“® ìŠ¤íƒ¬í”„ ìš”ì²­í•˜ê¸°</button>
    </div>
</div>

<nav class="bottom-nav">
    <a href="#/home"><span>ğŸ </span><span>í™ˆ</span></a>
    <a href="#/mission"><span>ğŸ¯</span><span>ë¯¸ì…˜</span></a>
    <a href="#/passport"><span>ğŸ“–</span><span>ì—¬ê¶Œ</span></a>
    <a href="#/ranking"><span>ğŸ†</span><span>ë­í‚¹</span></a>
    <a href="#/upload"><span>ğŸ“¸</span><span>ì¸ì¦</span></a>
</nav>

<div id="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:2000; overflow-y:auto;">
    <div id="modal-content"></div>
</div>
<div id="zoom-overlay" onclick="this.style.display='none'"><img id="zoom-img" style="max-width:100%; max-height:100%;"></div>
<button onclick="handleAdminAuth()" style="position:fixed; bottom:100px; right:15px; opacity:0; width:50px; height:50px; z-index:9999;">A</button>

<script>
    const firebaseConfig = { apiKey: "AIzaSyC9wLc0ei0c9r5PR7I4MPvGDTgoBB4AKGY", databaseURL: "https://assembly-passport-default-rtdb.firebaseio.com", projectId: "assembly-passport", appId: "1:5986706156:web:c2c5b6c167f38aef8a3bc9" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let isAdmin = false;
    let selectedScores = { base: true, leader: false, self: false };

    function handleAdminAuth() { if(prompt("ê´€ë¦¬ì ì½”ë“œ ì…ë ¥")==="assy") { isAdmin=true; updateUI(); } }
    function updateUI() {
        document.getElementById('admin-mission-area').style.display = isAdmin?'block':'none';
        document.getElementById('admin-approval-area').style.display = isAdmin?'block':'none';
        router();
    }

    function toggleScore(type) {
        if(type === 'base') return; // ê¸°ë³¸ì€ í•­ìƒ í¬í•¨
        selectedScores[type] = !selectedScores[type];
        document.getElementById('btn-'+type).classList.toggle('active-'+type);
    }

    /* [ê´€ë¦¬ì ìŠ¹ì¸ ë¦¬ìŠ¤íŠ¸ ë³µêµ¬] */
    function loadPending() {
        db.ref('activities').on('value', snap => {
            const list = document.getElementById('pending-list'); if(!list) return;
            const pending = Object.values(snap.val()||{}).filter(a => !a.isPassed);
            list.innerHTML = '';
            pending.forEach(item => {
                list.innerHTML += `<div class="card" style="border-left:6px solid var(--kia-red);">
                    <p><b>ğŸ“… ${item.month}ì›” í™œë™</b> | ğŸ‘¤ ${item.memberDetails.map(m=>`${m.name}(${m.score}p)`).join(', ')}</p>
                    <div class="pending-scroll">${item.imgs.map(img => `<img src="${img}">`).join('')}</div>
                    <p style="font-size:14px; background:#f5f5f5; padding:10px; border-radius:10px;">${item.content}</p>
                    <div class="admin-btns">
                        <button onclick="db.ref('activities/${item.id}').update({isPassed:true})" style="background:var(--success-blue)">ğŸ”µ Success</button>
                        <button onclick="location.hash='#/passport'" style="background:var(--success-green)">ğŸŸ¢ Pass</button>
                        <button onclick="if(confirm('ì‚­ì œ?')) db.ref('activities/${item.id}').remove()" style="background:var(--kia-red)">ğŸ”´ Delete</button>
                    </div>
                </div>`;
            });
        });
    }

    /* [ì—¬ê¶Œ íƒ­ - í”¼ë“œ ìŠ¤íƒ€ì¼ ë³µêµ¬] */
    function loadPassport() {
        db.ref('activities').on('value', snap => {
            const grid = document.getElementById('passport-grid'); if(!grid) return;
            grid.innerHTML = '';
            const all = Object.values(snap.val()||{});
            for(let i=1; i<=12; i++) {
                const monthActs = all.filter(a => a.month == i && a.isPassed);
                grid.innerHTML += `<div class="month-box" onclick="openDetail(${i})">
                    ${monthActs.length > 0 ? `<img src="${monthActs[0].imgs[0]}" style="width:100%; height:100%; object-fit:cover;">` : `<div style="height:100%; background:#eee;"></div>`}
                    ${monthActs.some(a => (new Date() - a.timestamp) < 86400000) ? `<div class="new-badge">N</div>` : ''}
                    <div style="position:absolute; bottom:0; width:100%; background:rgba(0,0,0,0.5); color:white; font-size:12px; text-align:center; padding:5px 0;">${i}ì›” í™œë™</div>
                </div>`;
            }
        });
    }

    function openDetail(month) {
        db.ref('activities').once('value', snap => {
            const acts = Object.values(snap.val()||{}).filter(a => a.month == month && a.isPassed);
            const content = document.getElementById('modal-content');
            content.innerHTML = `<div style="padding:15px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; background:white; z-index:100;"><h3 style="margin:0;">${month}ì›” ìƒì„¸ ê¸°ë¡</h3><button onclick="closeModal()" style="border:none; background:none; font-size:30px;">&times;</button></div>`;
            acts.forEach(act => {
                const members = act.memberDetails.map(m => `<span>${m.name}<span class="role-badge ${m.score>=10?'badge-leader':'badge-self'}">${m.score>=10?'íŒ€ì¥':'ìë°œ'}</span><small>(${m.score}p)</small></span>`).join(' ');
                content.innerHTML += `<div class="card" style="margin:15px; padding:0; overflow:hidden;">
                    <div style="padding:12px; font-weight:800; font-size:14px; border-bottom:1px solid #f9f9f9;">ğŸ‘¤ ${members}</div>
                    <div class="feed-img-slider">${act.imgs.map(img => `<img src="${img}" onclick="openZoom('${img}')">`).join('')}</div>
                    <div style="padding:15px; font-size:14px; line-height:1.6;">${act.content}</div>
                </div>`;
            });
            document.getElementById('modal').style.display='block';
        });
    }

    /* [ë­í‚¹ ë‹¨ìƒ ë³µêµ¬] */
    function loadRanking() {
        db.ref('activities').on('value', snap => {
            const uMap = {}; Object.values(snap.val()||{}).forEach(d => { if(d.isPassed) d.memberDetails.forEach(m => { uMap[m.name] = (uMap[m.name]||0) + m.score; }); });
            const sorted = Object.entries(uMap).sort((a,b)=>b[1]-a[1]);
            const podium = document.getElementById('podium-area');
            const list = document.getElementById('rank-list');
            const t = [sorted[0]||["-",0], sorted[1]||["-",0], sorted[2]||["-",0]];
            podium.innerHTML = `
                <div style="width:30%; height:100px; background:linear-gradient(#C0C0C0, #8E8E8E); border-radius:10px 10px 0 0; display:flex; flex-direction:column; align-items:center; color:white; font-weight:800; position:relative;"><span style="position:absolute; top:-25px; color:#333;">${t[1][0]}</span>ğŸ¥ˆ<br>${t[1][1]}p</div>
                <div style="width:30%; height:140px; background:linear-gradient(#FFD700, #DAA520); border-radius:10px 10px 0 0; display:flex; flex-direction:column; align-items:center; color:white; font-weight:800; position:relative;"><span style="position:absolute; top:-25px; color:var(--kia-red); font-weight:900;">ğŸ‘‘ ${t[0][0]}</span>ğŸ¥‡<br>${t[0][1]}p</div>
                <div style="width:30%; height:80px; background:linear-gradient(#CD7F32, #A0522D); border-radius:10px 10px 0 0; display:flex; flex-direction:column; align-items:center; color:white; font-weight:800; position:relative;"><span style="position:absolute; top:-25px; color:#333;">${t[2][0]}</span>ğŸ¥‰<br>${t[2][1]}p</div>`;
            list.innerHTML = sorted.slice(3).map((u,i)=>`<div style="display:flex; padding:15px; border-bottom:1px solid #f2f2f2;"><div style="width:35px; font-weight:800; color:#999;">${i+4}</div><div style="flex:1;">${u[0]}</div><b>${u[1]}p</b></div>`).join('');
        });
    }

    async function submitUpload() {
        const btn = document.getElementById('up-btn'); btn.disabled = true;
        const names = document.getElementById('up-names').value.split(',').map(n=>n.trim()).filter(n=>n);
        if(names.length === 0) { alert("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”."); btn.disabled=false; return; }
        let baseScore = 5;
        if(selectedScores.leader) baseScore += 2;
        if(selectedScores.self) baseScore += 3;
        const details = names.map(n => ({name: n, score: baseScore}));
        
        const imgs = []; 
        const files = document.getElementById('up-img').files;
        for(let f of files) {
            const data = await new Promise(res => {
                const reader = new FileReader(); reader.readAsDataURL(f);
                reader.onload = e => res(e.target.result);
            });
            imgs.push(data);
        }
        if(imgs.length === 0) { alert("ì‚¬ì§„ì„ ë“±ë¡í•˜ì„¸ìš”."); btn.disabled=false; return; }

        const ref = db.ref('activities').push();
        ref.set({id:ref.key, month:document.getElementById('up-month').value, memberDetails:details, imgs, content:document.getElementById('up-content').value, isPassed:false, timestamp: Date.now()})
           .then(()=>{alert("ì¸ì¦ ìš”ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"); location.hash="#/passport"; btn.disabled=false;});
    }

    function saveMission() {
        const text = document.getElementById('new-mission-text').value;
        const isHidden = document.getElementById('is-hidden-chk').checked;
        if(text) db.ref('mission_pool').push({text, isHidden}).then(()=> {
            document.getElementById('new-mission-text').value = '';
            document.getElementById('is-hidden-chk').checked = false;
            alert("ë¯¸ì…˜ ë“±ë¡ ì™„ë£Œ!");
        });
    }

    function loadMissions() {
        db.ref('mission_pool').on('value', snap => {
            const list = document.getElementById('mission-pool-list'); if(!list) return;
            list.innerHTML = '';
            Object.values(snap.val()||{}).forEach(m => {
                if(!m.isHidden) list.innerHTML += `<div class="card">ğŸ“Œ ${m.text}</div>`;
            });
        });
    }

    function router() {
        const h = location.hash.replace('#/', '') || 'home';
        document.querySelectorAll('[data-view]').forEach(v => v.classList.remove('active'));
        document.querySelectorAll('.bottom-nav a').forEach(a => {
            a.classList.remove('active-link');
            if(a.getAttribute('href') === '#/'+h) a.classList.add('active-link');
        });
        const target = document.getElementById('view-' + h); if(target) target.classList.add('active');
        if(h==='mission') { loadMissions(); if(isAdmin) loadPending(); }
        if(h==='passport') loadPassport();
        if(h==='ranking') loadRanking();
    }
    window.addEventListener('hashchange', router); window.addEventListener('load', router);
    function closeModal() { document.getElementById('modal').style.display='none'; }
    function openZoom(src) { document.getElementById('zoom-img').src = src; document.getElementById('zoom-overlay').style.display='flex'; }
</script>
</body>
</html>
