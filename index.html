<div id="view-mission" data-view class="container">
    <div id="admin-approval-area" style="display:none; margin-bottom:40px;">
        <h3 style="color:var(--kia-red);">ğŸ“¢ ìŠ¹ì¸ ëŒ€ê¸° (<span id="pending-count">0</span>)</h3>
        <div id="pending-list"></div>
    </div>

    <div id="admin-mission-area" style="display:none;" class="card">
        <h4>ğŸ› ï¸ ë¯¸ì…˜ ë§¤ë‹ˆì €</h4>
        <div class="mission-input-group">
            <input type="text" id="new-mission-text" placeholder="ì¼ë°˜ ë¯¸ì…˜ ë‚´ìš© ì…ë ¥">
            
            <label style="display:flex; align-items:center; gap:8px; margin-top:10px; cursor:pointer; width:fit-content;">
                <input type="checkbox" id="has-hidden-check" style="width:18px; height:18px;" onchange="document.getElementById('hidden-input-field').style.display=this.checked?'block':'none'">
                <span style="font-size:14px; font-weight:800; color:var(--success-blue);">ìˆ¨ì€ ë¯¸ì…˜ìœ¼ë¡œ ì„¤ì •</span>
            </label>

            <div id="hidden-input-field" style="display:none; margin-top:10px;">
                <input type="text" id="hidden-mission-text" placeholder="ìˆ¨ì€ ë¯¸ì…˜ ì„¸ë¶€ ë‚´ìš© ì…ë ¥">
            </div>
            
            <button onclick="addMissionPool()" class="btn-main">ë¯¸ì…˜ ë¦¬ìŠ¤íŠ¸ ë“±ë¡</button>
        </div>
        
        <hr style="margin:25px 0; border:0; border-top:1px solid #eee;">
        
        <div class="mission-input-group">
            <label style="font-size:13px; font-weight:800;">ì›”ë³„ ë¯¸ì…˜ ë§¤í•‘</label>
            <select id="match-month"><script>for(let i=1;i<=12;i++)document.write(`<option value="${i}">${i}ì›”</option>`)</script></select>
            <select id="match-mission-select" style="margin-top:8px;"></select>
            <button onclick="setMonthlyMission()" class="btn-main" style="background:var(--kia-red); border:none; color:white;">ë§¤í•‘ ì™„ë£Œ</button>
        </div>
    </div>

    <h3>ğŸ¯ ë¯¸ì…˜ ê°€ì´ë“œ</h3>
    <div id="mission-pool-list"></div>

    <h3 style="margin-top:30px;">ğŸ“… ì›”ë³„ ë°°ì • í˜„í™©</h3>
    <div id="monthly-history-list"></div>
</div>

<script>
    /* ë¯¸ì…˜ íƒ­ ì „ìš© í•µì‹¬ ìŠ¤í¬ë¦½íŠ¸ */
    
    // 1 & 2ë²ˆ: ë¯¸ì…˜ ë¡œë“œ ë° ê´€ë¦¬ì ê¶Œí•œ ì¡°íšŒ
    function loadMissions() {
        db.ref('mission_pool').on('value', snap => {
            const list = document.getElementById('mission-pool-list');
            const select = document.getElementById('match-mission-select');
            list.innerHTML = ''; select.innerHTML = '';
            const data = snap.val() || {};
            
            Object.entries(data).forEach(([id, item]) => {
                // ê´€ë¦¬ìì—ê²ŒëŠ” ìˆ¨ì€ ë¯¸ì…˜ë„ ë³´ì´ê³ , ì¼ë°˜ì¸ì—ê²ŒëŠ” ì¼ë°˜ ë¯¸ì…˜ë§Œ ì¡°íšŒë¨
                list.innerHTML += `<div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <b style="font-size:15px;">${item.text}</b>
                        ${isAdmin && item.hidden ? `<div style="color:var(--success-blue); font-size:12px; margin-top:4px;">ğŸ”’ ìˆ¨ì€ë‚´ìš©: ${item.hidden}</div>` : ''}
                    </div>
                    ${isAdmin ? `<button onclick="if(confirm('ì‚­ì œí• ê¹Œìš”?')) db.ref('mission_pool/${id}').remove()" style="background:#fff1f0; color:#ff4d4f; border:1px solid #ffa39e; padding:6px 10px; border-radius:8px; font-size:12px; font-weight:800;">ì‚­ì œ</button>` : ''}
                </div>`;
                select.innerHTML += `<option value="${id}">${item.text}</option>`;
            });
        });

        db.ref('monthly_missions').on('value', snap => {
            const hist = document.getElementById('monthly-history-list'); hist.innerHTML = '';
            const data = snap.val() || {};
            for(let i=1; i<=12; i++){
                if(data[i]){
                    hist.innerHTML += `<div class="card" style="border-left:5px solid var(--passport-navy); display:flex; justify-content:space-between; align-items:center;">
                        <div style="flex:1; padding-right:10px;">
                            <span style="font-weight:800; color:var(--passport-navy);">${i}ì›”: ${data[i].text}</span>
                            ${data[i].hidden ? `<div style="color:var(--success-blue); font-weight:800; font-size:14px; margin-top:6px;">â­ ìˆ¨ì€ë¯¸ì…˜: ${data[i].hidden}</div>` : ''}
                        </div>
                        ${isAdmin ? `<button onclick="if(confirm('ë§¤í•‘ì„ ì‚­ì œí• ê¹Œìš”?')) db.ref('monthly_missions/${i}').remove()" style="background:#fff1f0; color:#ff4d4f; border:1px solid #ffa39e; padding:6px 10px; border-radius:8px; font-size:12px; font-weight:800;">ì‚­ì œ</button>` : ''}
                    </div>`;
                }
            }
        });
    }

    function addMissionPool() {
        const text = document.getElementById('new-mission-text').value;
        const hidden = document.getElementById('has-hidden-check').checked ? document.getElementById('hidden-mission-text').value : null;
        if(!text) return alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”");
        db.ref('mission_pool').push({text, hidden}).then(() => {
            alert("ë¯¸ì…˜ ë“±ë¡ ì™„ë£Œ");
            document.getElementById('new-mission-text').value='';
            document.getElementById('hidden-mission-text').value='';
            document.getElementById('has-hidden-check').checked = false;
            document.getElementById('hidden-input-field').style.display = 'none';
        });
    }

    // 3ë²ˆ: ê´€ë¦¬ì ìŠ¹ì¸ (Success / Pass / ì‚­ì œ 3ë‹¨ êµ¬ì„±)
    function loadApprovalList() {
        db.ref('activities').on('value', snap => {
            const list = document.getElementById('pending-list'); list.innerHTML = '';
            let count = 0;
            const data = snap.val() || {};
            Object.values(data).filter(d => !d.isPassed).forEach(item => {
                count++;
                const memberInfo = item.memberDetails.map(m => `<span style="background:#eee; padding:2px 6px; border-radius:4px; margin-right:4px;">${m.name}(${m.score}p)</span>`).join('');
                list.innerHTML += `<div class="card" style="padding:15px;">
                    <div style="font-size:12px; color:#888; margin-bottom:5px;">${item.month}ì›” í™œë™ ì‹ ì²­</div>
                    <div style="font-weight:800; margin-bottom:8px;">ğŸ‘¥ ì¸ì›: ${memberInfo}</div>
                    <div style="background:#fcfaf2; border:1px solid #eee; padding:12px; border-radius:10px; font-size:14px; line-height:1.5; margin-bottom:10px;">${item.content || "ìƒì„¸ ë‚´ìš© ì—†ìŒ"}</div>
                    <div style="display:flex; overflow-x:auto; gap:8px; margin-bottom:15px;">
                        ${item.imgs.map(src => `<img src="${src}" style="width:110px; height:110px; object-fit:cover; border-radius:8px; flex-shrink:0;">`).join('')}
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px;">
                        <button onclick="approveAct('${item.id}', 'success')" style="background:var(--success-blue); color:white; border:none; height:48px; border-radius:12px; font-weight:800; font-size:13px;">Success</button>
                        <button onclick="approveAct('${item.id}', 'pass')" style="background:#28a745; color:white; border:none; height:48px; border-radius:12px; font-weight:800; font-size:13px;">Pass</button>
                        <button onclick="if(confirm('ë°ì´í„°ë¥¼ ì˜êµ¬ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) db.ref('activities/${item.id}').remove()" style="background:#666; color:white; border:none; height:48px; border-radius:12px; font-weight:800; font-size:13px;">ì‚­ì œ</button>
                    </div>
                </div>`;
            });
            document.getElementById('pending-count').innerText = count;
        });
    }

    function approveAct(id, type) { 
        db.ref('activities/'+id).update({isPassed:true, approvalType:type}).then(()=>alert("ì²˜ë¦¬ ì™„ë£Œ")); 
    }

    function setMonthlyMission() {
        const m = document.getElementById('match-month').value;
        const id = document.getElementById('match-mission-select').value;
        if(!id) return alert("ë¯¸ì…˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”");
        db.ref('mission_pool/'+id).once('value', snap => {
            db.ref('monthly_missions/'+m).set(snap.val()).then(() => alert(m+"ì›” ë¯¸ì…˜ ë°°ì • ì™„ë£Œ"));
        });
    }
</script>
