<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover"/>
    <title>KIA ì¡°ë¦½1ë¶€ ë¬¸í™”ì—¬ê¶Œ</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;800&family=Dancing+Script:wght@700&display=swap');
        :root { --kia-navy: #051435; --kia-red: #bb0a30; --kia-silver: #f2f2f2; --bg: #f8f9fb; }
        
        body { margin: 0; font-family: 'Pretendard', sans-serif; background: var(--bg); color: #1c1c1e; padding-bottom: 100px; -webkit-tap-highlight-color: transparent; }
        header { background: var(--kia-navy); color: white; padding: calc(15px + env(safe-area-inset-top)) 20px 15px; text-align: center; border-bottom: 3px solid var(--kia-red); position: sticky; top:0; z-index: 1000; }
        
        /* ê¸°ì•„ ìµœì‹  ë¡œê³  ìŠ¤íƒ€ì¼ */
        .kia-logo-modern { font-size: 40px; font-weight: 900; letter-spacing: -3px; color: white; line-height: 1; margin-bottom: 5px; font-family: sans-serif; }
        
        .container { padding: 15px; max-width: 500px; margin: 0 auto; }
        .card { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 15px; }

        /* ì—¬ê¶Œ í™ˆ ë””ìì¸ */
        .passport-cover { background: var(--kia-navy); border-radius: 24px; padding: 50px 20px; text-align: center; position: relative; overflow: hidden; box-shadow: 0 15px 35px rgba(0,0,0,0.3); color: white; }
        .dept-info { font-size: 14px; letter-spacing: 2px; color: var(--kia-red); font-weight: 800; margin-bottom: 30px; }

        /* ì‚¬ì§„ ì¤Œ ê´€ë ¨ */
        .feed-img-box { width: 100%; overflow: hidden; background: #000; position: relative; }
        .feed-img-box img { width: 100%; transition: transform 0.3s ease; cursor: zoom-in; }
        .feed-img-box img:active { transform: scale(1.5); } /* ëª¨ë°”ì¼ í„°ì¹˜ ì‹œ í™•ëŒ€ ê¸°ëŠ¥ */

        /* ë¯¸ì…˜ ê´€ë¦¬ UI */
        .mission-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee; font-size: 14px; }
        .btn-sm { padding: 5px 10px; border-radius: 8px; font-size: 12px; border: none; cursor: pointer; }
        
        /* íŒ¨ìŠ¤ ìŠ¤íƒ¬í”„ */
        .pass-stamp { position: absolute; top: 20px; right: 20px; border: 3px solid var(--kia-red); color: var(--kia-red); font-family: 'Dancing Script', cursive; font-size: 26px; padding: 4px 12px; border-radius: 8px; transform: rotate(-15deg); font-weight: 700; z-index: 5; background: rgba(255,255,255,0.8); }

        /* ì—¬ê¶Œ ê·¸ë¦¬ë“œ & ë°°ì§€ */
        .passport-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .month-box { background: white; border-radius: 18px; overflow: hidden; height: 160px; border: 1px solid #e5e5ea; position: relative; }
        .new-badge { position: absolute; top: 10px; left: 10px; background: var(--kia-red); color: white; font-size: 10px; font-weight: 900; padding: 2px 6px; border-radius: 4px; z-index: 10; animation: blink 1.5s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* í•˜ë‹¨ë°” & ë²„íŠ¼ */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; display: flex; border-top: 1px solid #eee; padding-bottom: env(safe-area-inset-bottom); height: 70px; z-index: 1000; }
        .bottom-nav a { flex: 1; text-decoration: none; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #8e8e93; font-size: 11px; }
        .bottom-nav a.active-link { color: var(--kia-navy); font-weight: 800; }
        .btn-ui { width: 100%; height: 50px; border-radius: 12px; font-weight: 800; border: none; margin-top: 10px; cursor: pointer; }
        .btn-navy { background: var(--kia-navy); color: white; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 2000; overflow-y: auto; }
        [data-view] { display: none; } [data-view].active { display: block; }
        input, select { -webkit-appearance: none; border: 1px solid #ddd; padding: 12px; border-radius: 12px; width: 100%; box-sizing: border-box; font-size: 16px; margin-top: 8px; }
    </style>
</head>
<body>

<header><h1>KIA ASSEMBLY PART 1</h1></header>

<div class="container">
    <div id="view-home" data-view class="active">
        <div class="passport-cover">
            <div class="kia-logo-modern">KIA</div>
            <div class="dept-info">MOVEMENT THAT INSPIRES</div>
            <div style="font-size: 24px; font-weight: 800; margin-bottom: 40px;">ë¬¸í™”ì—¬ê¶Œ</div>
            <div class="card" style="background: rgba(255,255,255,0.1); border: 1px dashed white; color: white;">
                <div style="font-size: 11px; opacity: 0.7; margin-bottom: 5px;">í˜„ì¬ ë¯¸ì…˜</div>
                <div id="home-mission-display" style="font-size: 18px; font-weight: 800;">ì§€ì •ëœ ë¯¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.</div>
            </div>
        </div>
    </div>

    <div id="view-mission" data-view>
        <div id="admin-mission-area" style="display:none; margin-bottom: 30px; border: 2px solid var(--kia-red); padding: 15px; border-radius: 20px;">
            <h3 style="margin-top:0;">ğŸ› ï¸ ë¯¸ì…˜ ê´€ë¦¬ ì‹œìŠ¤í…œ</h3>
            <div class="card">
                <p style="font-weight:700; margin:0;">1. ë¯¸ì…˜ í’€(Pool) ë¦¬ìŠ¤íŠ¸ ì‘ì„±</p>
                <input type="text" id="new-mission-text" placeholder="ë¯¸ì…˜ ë‚´ìš© ì…ë ¥">
                <button onclick="addMissionToPool()" class="btn-ui btn-navy">ë¯¸ì…˜ ì¶”ê°€</button>
                <div id="mission-pool-display" style="margin-top:15px; max-height: 150px; overflow-y: auto;"></div>
            </div>
            <div class="card">
                <p style="font-weight:700; margin:0;">2. ì›”ë³„ ë¯¸ì…˜ ë°°ì •</p>
                <select id="match-month">
                    <script>for(let i=1;i<=12;i++) document.write(`<option value="${i}">${i}ì›”</option>`)</script>
                </select>
                <select id="match-mission-select"><option>ë¯¸ì…˜ì„ ë¨¼ì € ì¶”ê°€í•˜ì„¸ìš”</option></select>
                <button onclick="matchMissionToMonth()" class="btn-ui" style="background:var(--kia-red); color:white;">í•´ë‹¹ ì›”ì— ë°°ì •</button>
            </div>
        </div>

        <h3>ğŸ¯ ì›”ë³„ ë¯¸ì…˜ ë°°ì • í˜„í™©</h3>
        <div id="monthly-match-display"></div>
    </div>

    <div id="view-passport" data-view>
        <h3 style="margin-bottom:15px;">ğŸ“– ìŠ¤íƒ¬í”„ íˆìŠ¤í† ë¦¬</h3>
        <div class="passport-grid" id="passport-grid"></div>
    </div>

    <div id="view-ranking" data-view>
        <div id="podium-area"></div>
        <div class="card" id="rank-list" style="padding:0;"></div>
    </div>

    <div id="view-upload" data-view>
        <div class="card">
            <h3 style="margin:0 0 15px 0;">ğŸ“¸ í™œë™ ì¸ì¦</h3>
            <select id="up-month">
                <script>const m=new Date().getMonth()+1; for(let i=1;i<=12;i++) document.write(`<option value="${i}" ${i===m?'selected':''}>${i}ì›” í™œë™</option>`)</script>
            </select>
            <input type="text" id="up-name" placeholder="ì°¸ì—¬ì ì„±í•¨ (ì‰¼í‘œ êµ¬ë¶„)" oninput="generateScoreFields()">
            <div id="score-fields-area"></div>
            <input type="text" id="up-content" placeholder="í™œë™ ì†Œê°">
            <input type="file" id="up-img" accept="image/*" multiple style="margin-top:20px;">
            <button onclick="submitUpload()" id="up-btn" class="btn-ui btn-navy">ê¸°ë¡ ì œì¶œ</button>
        </div>
    </div>
</div>

<nav class="bottom-nav">
    <a href="#/home" id="link-home"><span>ğŸ </span>í™ˆ</a>
    <a href="#/mission" id="link-mission"><span>ğŸ¯</span>ë¯¸ì…˜</a>
    <a href="#/passport" id="link-passport"><span>ğŸ“–</span>ì—¬ê¶Œ</a>
    <a href="#/ranking" id="link-ranking"><span>ğŸ†</span>ë­í‚¹</a>
    <a href="#/upload" id="link-upload"><span>ğŸ“¸</span>ì—…ë¡œë“œ</a>
</nav>

<div id="modal" class="modal">
    <div style="background:white; padding:15px 20px; display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; z-index:100; border-bottom:1px solid #eee;">
        <div id="modal-title" style="font-weight:800;">í™œë™ í”¼ë“œ</div>
        <div onclick="closeModal()" style="font-size:30px; color:#ccc; cursor:pointer;">&times;</div>
    </div>
    <div id="modal-body-content"></div>
</div>

<button onclick="handleAdminAuth()" id="admin-tag" style="position:fixed; bottom:85px; right:15px; background:rgba(0,0,0,0.05); color:white; border:none; padding:5px 10px; border-radius:10px; font-size:10px; z-index:900;">Admin</button>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyC9wLc0ei0c9r5PR7I4MPvGDTgoBB4AKGY",
        databaseURL: "https://assembly-passport-default-rtdb.firebaseio.com",
        projectId: "assembly-passport",
        appId: "1:5986706156:web:c2c5b6c167f38aef8a3bc9"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let isAdmin = false;

    function handleAdminAuth() {
        if(!isAdmin) { if(prompt("ê´€ë¦¬ì ì½”ë“œ")==="assy") { isAdmin=true; document.getElementById('admin-mission-area').style.display='block'; } }
        else { isAdmin=false; document.getElementById('admin-mission-area').style.display='none'; }
        router();
    }

    // 1. ë¯¸ì…˜ í’€(Pool) ê´€ë¦¬ ë¡œì§
    function addMissionToPool() {
        const text = document.getElementById('new-mission-text').value;
        if(text) db.ref('mission_pool').push({ text }).then(() => document.getElementById('new-mission-text').value = '');
    }
    function deleteMissionFromPool(id) { if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) db.ref('mission_pool/'+id).remove(); }
    function matchMissionToMonth() {
        const m = document.getElementById('match-month').value;
        const text = document.getElementById('match-mission-select').value;
        db.ref('monthly_missions/'+m).set({ text }).then(() => alert(m+"ì›” ë¯¸ì…˜ ë°°ì • ì™„ë£Œ"));
    }

    // 2. ë¯¸ì…˜ ë°ì´í„° ë¡œë“œ
    function loadMissionData() {
        db.ref('mission_pool').on('value', snap => {
            const pool = snap.val() || {};
            const poolDisplay = document.getElementById('mission-pool-display');
            const selectMatch = document.getElementById('match-mission-select');
            poolDisplay.innerHTML = ''; selectMatch.innerHTML = '';
            Object.entries(pool).forEach(([id, data]) => {
                poolDisplay.innerHTML += `<div class="mission-item">${data.text} <button onclick="deleteMissionFromPool('${id}')" class="btn-sm" style="background:#ffefef; color:red;">ì‚­ì œ</button></div>`;
                selectMatch.innerHTML += `<option value="${data.text}">${data.text}</option>`;
            });
        });
        db.ref('monthly_missions').on('value', snap => {
            const matched = snap.val() || {};
            const display = document.getElementById('monthly-match-display');
            display.innerHTML = '';
            const curM = new Date().getMonth() + 1;
            for(let i=1; i<=12; i++) {
                const missionText = matched[i] ? matched[i].text : "ë¯¸ë°°ì •";
                display.innerHTML += `<div class="card" style="padding:15px; border-left:5px solid ${matched[i]? 'var(--kia-navy)':'#eee'};"><b>${i}ì›” ë¯¸ì…˜:</b> ${missionText}</div>`;
                if(i == curM) document.getElementById('home-mission-display').innerText = missionText;
            }
        });
    }

    // 3. [ê³ ì •] ì›”ë³„ ì¡°íšŒ í•µì‹¬ ë¡œì§ (í”¼ë“œí˜• + ì¤Œ ê¸°ëŠ¥)
    function openDetail(month, allData) {
        const body = document.getElementById('modal-body-content');
        body.innerHTML = '';
        const filtered = allData.filter(d => d.month == month && d.isPassed);
        document.getElementById('modal-title').innerText = month + "ì›” í™œë™ ë‚´ì—­";

        filtered.sort((a,b) => b.timestamp - a.timestamp).forEach(item => {
            const card = document.createElement('div');
            card.className = 'feed-card';
            card.innerHTML = `
                <div class="pass-stamp">Passed</div>
                <div class="feed-img-box" onclick="toggleZoom(this)">
                    ${item.imgs.map(img => `<img src="${img}">`).join('')}
                </div>
                <div style="padding:20px;">
                    <div style="display:flex; flex-wrap:wrap; gap:5px; margin-bottom:10px;">
                        ${(item.memberDetails || []).map(m => `<span style="background:#f2f2f7; padding:4px 10px; border-radius:8px; font-size:12px; font-weight:700;">${m.name} (+${m.score})</span>`).join('')}
                    </div>
                    <div style="font-size:15px; line-height:1.6;">${item.content || "í™œë™ ì™„ë£Œ!"}</div>
                </div>`;
            body.appendChild(card);
        });
        document.getElementById('modal').style.display = 'block';
        document.body.style.overflow = 'hidden';
    }

    function toggleZoom(box) {
        const img = box.querySelector('img');
        img.style.transform = (img.style.transform === 'scale(1.5)') ? 'scale(1)' : 'scale(1.5)';
    }

    // 4. [ê³ ì •] ë°ì´í„° ì—…ë¡œë“œ ë¡œì§
    async function submitUpload() {
        const nameVal = document.getElementById('up-name').value.trim();
        const files = document.getElementById('up-img').files;
        if(!nameVal || files.length === 0) return alert("ì°¸ì—¬ìì™€ ì‚¬ì§„ì„ ì…ë ¥í•˜ì„¸ìš”.");
        const names = nameVal.split(',').map(n => n.trim());
        const memberDetails = [];
        document.querySelectorAll('.score-group').forEach((group, i) => {
            let s = 0; group.querySelectorAll('.score-chip.active').forEach(c => s += parseInt(c.dataset.val));
            memberDetails.push({ name: names[i], score: s });
        });
        const imgs = [];
        for(let f of files) { imgs.push(await new Promise(res => { const r = new FileReader(); r.readAsDataURL(f); r.onload = (e) => res(e.target.result); })); }
        const newRef = db.ref('activities').push();
        newRef.set({
            id: newRef.key, names, memberDetails, month: document.getElementById('up-month').value,
            imgs, content: document.getElementById('up-content').value,
            isPassed: false, timestamp: Date.now(), date: new Date().toLocaleDateString()
        }).then(() => { alert("ìŠ¹ì¸ ìš”ì²­ ì™„ë£Œ!"); location.hash = "#/passport"; });
    }

    // ê¸°íƒ€ ë Œë”ë§ í•¨ìˆ˜
    function loadPassport() {
        db.ref('activities').on('value', snap => {
            const grid = document.getElementById('passport-grid'); grid.innerHTML = '';
            const all = snap.val() ? Object.values(snap.val()) : [];
            const now = Date.now();
            for(let i=1; i<=12; i++) {
                const approved = all.filter(d => d.month == i && d.isPassed);
                const hasNew = approved.some(d => (now - d.timestamp) < (24 * 60 * 60 * 1000));
                const box = document.createElement('div');
                box.className = 'month-box';
                box.onclick = () => openDetail(i, all);
                box.innerHTML = (hasNew ? `<div class="new-badge">N</div>` : '') + 
                    (approved.length > 0 ? `<img src="${approved[0].imgs[0]}" style="width:100%; height:110px; object-fit:cover;"><div class="month-label">${i}ì›”</div>` : `<div style="height:110px;"></div><div class="month-label" style="color:#ccc;">${i}ì›”</div>`);
                grid.appendChild(box);
            }
        });
    }

    function generateScoreFields() {
        const area = document.getElementById('score-fields-area');
        const names = document.getElementById('up-name').value.split(',').map(n => n.trim()).filter(n => n !== "");
        area.innerHTML = '';
        names.forEach((name, idx) => {
            area.innerHTML += `<div class="card" style="margin-top:10px; background:#f9f9f9;">
                <div style="font-size:13px; font-weight:800; margin-bottom:8px;">${name}</div>
                <div class="score-group" data-idx="${idx}">
                    <div class="score-chip chip-base active" data-val="5" onclick="this.classList.toggle('active')">ê¸°ë³¸(+5)</div>
                    <div class="score-chip chip-leader" data-val="2" onclick="this.classList.toggle('active')">íŒ€ì¥(+2)</div>
                    <div class="score-chip chip-self" data-val="3" onclick="this.classList.toggle('active')">ìë°œ(+3)</div>
                </div></div>`;
        });
    }

    function router() {
        const hash = location.hash.replace('#/', '') || 'home';
        document.querySelectorAll('[data-view]').forEach(v => v.classList.remove('active'));
        document.querySelectorAll('.bottom-nav a').forEach(a => a.classList.remove('active-link'));
        document.getElementById('view-' + hash).classList.add('active');
        document.getElementById('link-' + hash).classList.add('active-link');
        if(hash === 'mission') loadMissionData();
        if(hash === 'passport') loadPassport();
        if(hash === 'home') loadMissionData();
    }
    function closeModal() { document.getElementById('modal').style.display = 'none'; document.body.style.overflow = 'auto'; }
    window.addEventListener('hashchange', router); window.addEventListener('load', router);
</script>
</body>
</html>
